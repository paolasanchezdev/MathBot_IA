// games.js
(function(){
  function getBest(){ try { return parseInt(localStorage.getItem('mb_qm_best')||'0',10)||0 } catch { return 0 } }
  function setBest(v){ try { localStorage.setItem('mb_qm_best', String(v)); } catch {} }

  function QuickMath(el){
    const startBtn = el.querySelector('#qm-start');
    const bestEl = el.querySelector('#qm-best');
    const area = el.querySelector('#qm-area');
    const timeEl = el.querySelector('#qm-time');
    const scoreEl = el.querySelector('#qm-score');
    const qEl = el.querySelector('#qm-question');
    const form = el.querySelector('#qm-form');
    const answer = el.querySelector('#qm-answer');
    const feedback = el.querySelector('#qm-feedback');

    let timer = null, time=60, score=0, current=0;

    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min }
    function gen(){
      const ops = ['+','-','Ã—','Ã·'];
      const op = ops[rand(0, ops.length-1)];
      let a = rand(2, 15), b = rand(2, 15);
      if (op==='Ã·') { a = a*b; }
      current = eval(String(a) + (op==='Ã—'?'*':op==='Ã·'?'/':op) + String(b));
      qEl.textContent = `${a} ${op} ${b} = ?`;
      answer.value = '';
      answer.focus();
    }
    function tick(){ time--; timeEl.textContent = String(time); if (time<=0){ end(); } }
    function start(){
      score = 0; time = 60; scoreEl.textContent='0'; timeEl.textContent='60'; feedback.textContent='';
      startBtn.disabled = true; area.style.display='block'; gen();
      if (timer) clearInterval(timer); timer = setInterval(tick, 1000);
    }
    function end(){
      if (timer) { clearInterval(timer); timer = null; }
      startBtn.disabled = false; area.style.display='none';
      const best = getBest();
      if (score>best) { setBest(score); bestEl.textContent = String(score); alert(`Â¡Nuevo rÃ©cord! ${score} puntos`); }
      else { alert(`Tiempo! Puntos: ${score}. Mejor: ${best}`); }
    }
    function submit(e){ e.preventDefault(); const val = Number(answer.value); if (Number.isFinite(val) && Math.abs(val-current) < 1e-9){ score++; scoreEl.textContent = String(score); feedback.textContent='âœ”ï¸ Correcto'; feedback.style.color='var(--success, #16a34a)'; gen(); } else { feedback.textContent='âœ–ï¸ Intenta de nuevo'; feedback.style.color='var(--danger, #dc2626)'; } }

    bestEl.textContent = String(getBest());
    startBtn.addEventListener('click', start);
    form.addEventListener('submit', submit);
  }

  function initGamesSection(){
    const card = document.getElementById('quick-math-card');
    if (card) QuickMath(card);
  }
  window.initGamesSection = initGamesSection;
})();


